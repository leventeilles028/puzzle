<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Puzzle</title>
<style>
:root {
  --bg:#0f172a; --card:#1e293b; --accent:#06b6d4; --muted:#94a3b8;
}
* { box-sizing:border-box; margin:0; padding:0 }
body {
  font-family:Inter,system-ui,Arial,sans-serif;
  background:var(--bg); color:#fff;
  min-height:100vh; display:flex; align-items:center; justify-content:center;
}
.app {
  width:95%; max-width:1200px;
  display:grid; grid-template-columns:1fr 320px;
  gap:20px; padding:20px;
}
header {
  grid-column:1/-1;
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:12px;
}
h1 { font-size:20px }
.btn {
  background:var(--accent); color:#000; font-weight:600;
  border:none; padding:8px 12px; border-radius:8px; cursor:pointer;
}
.panel {
  background:var(--card); padding:12px; border-radius:10px;
}
.boardWrap {
  position:relative; height:520px;
  border-radius:10px; overflow:hidden; background:#081021;
}
#boardBg { width:100%; height:100%; display:block }
#boardPlace {
  position:absolute; left:0; top:0; width:100%; height:100%;
}
.tray {
  display:flex; flex-wrap:wrap; justify-content:flex-start; align-content:flex-start;
  gap:8px; height:520px; border-radius:10px; overflow:auto;
  background:#0b1220; padding:10px;
}
.thumb {
  width:90px; height:90px; object-fit:cover; border-radius:6px;
  box-shadow:0 6px 18px rgba(0,0,0,0.6); cursor:grab;
  transition: transform 0.2s, box-shadow 0.2s;
}
.thumb.dragging {
  transform: scale(1.2);
  box-shadow:0 12px 28px rgba(0,0,0,0.7);
  cursor:grabbing;
}
.thumb.shake { animation: shake 0.3s }
@keyframes shake { 0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)} }
.placed {
  position:absolute; pointer-events:none;
  transition:transform 0.15s ease;
}
.overlay-complete {
  position:absolute; left:0; top:0; width:100%; height:100%;
  display:flex; align-items:center; justify-content:center;
  font-size:28px; font-weight:700;
  background:rgba(0,0,0,0.35);
  animation:fadeIn .4s ease forwards;
}
@keyframes fadeIn { from{opacity:0; transform:scale(.9)} to{opacity:1; transform:scale(1)} }
.error-msg {
  position:absolute; color:red; font-weight:bold; font-size:16px;
  pointer-events:none; opacity:0; transition:opacity 0.3s;
}
#timer {
  font-weight:bold; font-size:16px; color:var(--muted);
}
@media(max-width:900px) {
  .app{grid-template-columns:1fr}
  .tray{height:260px}
  .boardWrap{height:260px}
}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1></h1>
    <div style="display:flex;gap:10px;align-items:center">
      <label class="btn">Kép feltöltése<input id="fileInput" type="file" accept="image/*" style="display:none"></label>
      <select id="difficulty" class="btn">
        <option value="3">Könnyű (3x3)</option>
        <option value="5" selected>Közepes (5x5)</option>
        <option value="8">Nehéz (8x8)</option>
      </select>
      <button id="shuffleBtn" class="btn">Újrakeverés</button>
      <span id="timer">⏱ 0s</span>
    </div>
  </header>

  <div class="panel boardWrap">
    <canvas id="boardBg"></canvas>
    <div id="boardPlace"></div>
  </div>

  <div class="panel tray" id="tray"></div>
</div>

<script>
const fileInput = document.getElementById('fileInput')
const difficulty = document.getElementById('difficulty')
const shuffleBtn = document.getElementById('shuffleBtn')
const tray = document.getElementById('tray')
const boardBg = document.getElementById('boardBg')
const boardPlace = document.getElementById('boardPlace')
const timerEl = document.getElementById('timer')

let img = new Image()
let pieces = []
let rows = 5, cols = 5
let timer = null, elapsed = 0, gameStarted = false

fileInput.addEventListener('change', e => {
  const f = e.target.files[0]; if(!f) return
  const url = URL.createObjectURL(f)
  img.onload = () => { URL.revokeObjectURL(url); setup() }
  img.src = url
})

difficulty.addEventListener('change', () => {
  rows = cols = parseInt(difficulty.value)
  if (img.src) setup()
})

shuffleBtn.addEventListener('click', () => {
  if (!pieces.length) return
  document.querySelectorAll('.placed').forEach(e => e.remove())
  document.querySelectorAll('.overlay-complete').forEach(e => e.remove())
  pieces.forEach(p => p.placed = false)
  stopTimer()
  elapsed = 0
  updateTimer()
  gameStarted = false
  createTrayThumbs()
})

function startTimer(){
  if (timer) return
  timer = setInterval(() => { elapsed++; updateTimer() }, 1000)
}
function stopTimer(){
  if (timer) { clearInterval(timer); timer = null }
}
function updateTimer(){
  timerEl.textContent = `⏱ ${elapsed}s`
}

function setup(){
  document.querySelectorAll('.overlay-complete').forEach(e => e.remove())
  pieces = []
  boardPlace.innerHTML = ''
  tray.innerHTML = ''

  const ctx = boardBg.getContext('2d')
  boardBg.width = boardPlace.clientWidth
  boardBg.height = boardPlace.clientHeight
  ctx.clearRect(0,0,boardBg.width,boardBg.height)
  ctx.fillStyle = '#081021'
  ctx.fillRect(0,0,boardBg.width,boardBg.height)

  const aspect = img.width / img.height
  let drawW = boardBg.width, drawH = boardBg.height
  if (boardBg.width / boardBg.height > aspect) drawW = boardBg.height * aspect
  else drawH = boardBg.width / aspect
  const offsetX = (boardBg.width - drawW) / 2
  const offsetY = (boardBg.height - drawH) / 2

  const cellW = drawW / cols, cellH = drawH / rows
  const pw = Math.floor(img.width / cols), ph = Math.floor(img.height / rows)

  for (let r = 0; r < rows; r++){
    for (let c = 0; c < cols; c++){
      const off = document.createElement('canvas')
      off.width = pw; off.height = ph
      off.getContext('2d').drawImage(img, c*pw, r*ph, pw, ph, 0, 0, pw, ph)
      pieces.push({
        id: `${r}-${c}`,
        row: r, col: c,
        dataUrl: off.toDataURL(),
        placed: false,
        offsetX, offsetY, cellW, cellH
      })
      ctx.strokeStyle = 'rgba(255,255,255,0.08)'
      ctx.strokeRect(offsetX + c*cellW, offsetY + r*cellH, cellW, cellH)
    }
  }

  stopTimer()
  elapsed = 0
  updateTimer()
  gameStarted = false
  createTrayThumbs()
}

function createTrayThumbs(){
  tray.innerHTML = ''
  pieces.sort(() => Math.random() - 0.5)
  pieces.forEach(p => {
    p.placed = false
    const imgEl = document.createElement('img')
    imgEl.src = p.dataUrl
    imgEl.dataset.id = p.id
    imgEl.className = 'thumb'
    tray.appendChild(imgEl)
    makeDrag(imgEl, p)
  })
}

function makeDrag(el, piece){
  let clone = null, offsetX = 0, offsetY = 0
  el.addEventListener('pointerdown', e => {
    e.preventDefault()
    if (!gameStarted) { startTimer(); gameStarted = true }
    const rect = el.getBoundingClientRect()
    offsetX = e.pageX - rect.left
    offsetY = e.pageY - rect.top

    clone = el.cloneNode()
    clone.style.position = 'fixed'
    clone.style.left = (e.pageX - offsetX) + 'px'
    clone.style.top = (e.pageY - offsetY) + 'px'
    clone.style.width = rect.width + 'px'
    clone.style.height = rect.height + 'px'
    clone.style.zIndex = 9999
    clone.style.pointerEvents = 'none'
    clone.classList.add('dragging')
    document.body.appendChild(clone)

    window.addEventListener('pointermove', onMove)
    window.addEventListener('pointerup', onUp)
  })

  function onMove(e){
    if (!clone) return
    clone.style.left = (e.pageX - offsetX) + 'px'
    clone.style.top = (e.pageY - offsetY) + 'px'
  }

  function onUp(e){
    if (!clone) return
    const bRect = boardPlace.getBoundingClientRect()
    const bx = e.pageX - bRect.left
    const by = e.pageY - bRect.top

    const insideX = bx >= piece.offsetX && bx <= piece.offsetX + piece.cellW * cols
    const insideY = by >= piece.offsetY && by <= piece.offsetY + piece.cellH * rows

    if (insideX && insideY) {
      const relX = bx - piece.offsetX
      const relY = by - piece.offsetY
      const col = Math.floor(relX / piece.cellW)
      const row = Math.floor(relY / piece.cellH)

      if (row === piece.row && col === piece.col && !piece.placed) {
        placePiece(piece, row, col, piece.cellW, piece.cellH, el)
      } else {
        el.classList.add('shake')
        setTimeout(()=>el.classList.remove('shake'), 300)
        showError(clone, 'Nem ide való!')
      }
    }

    clone.remove()
    clone = null
    window.removeEventListener('pointermove', onMove)
    window.removeEventListener('pointerup', onUp)
  }
}

function placePiece(piece, row, col, cellW, cellH, originEl){
  const imgEl = document.createElement('img')
  imgEl.src = piece.dataUrl
  imgEl.className = 'placed'
  imgEl.style.left = (piece.offsetX + col*cellW) + 'px'
  imgEl.style.top  = (piece.offsetY + row*cellH) + 'px'
  imgEl.style.width = cellW + 'px'
  imgEl.style.height = cellH + 'px'
  imgEl.style.transform = 'scale(1.2)'
  boardPlace.appendChild(imgEl)
  requestAnimationFrame(()=> imgEl.style.transform = 'scale(1)')
  piece.placed = true
  try { originEl.remove() } catch(e) { }
  checkComplete()
}

function checkComplete(){
  if (pieces.every(p => p.placed)) {
    stopTimer()
    document.querySelectorAll('.overlay-complete').forEach(e => e.remove())
    const overlay = document.createElement('div')
    overlay.className = 'overlay-complete'
    overlay.textContent = `MEGCSINÁLTAD! Idő: ${elapsed}s`
    boardPlace.appendChild(overlay)

    if (rows === 8 && cols === 8) {
      setTimeout(() => {
        window.location.href = "https://www.youtube.com/watch?v=geyARlESiaM"
      }, 3000)
    } else if (rows === 5 && cols === 5) {
      setTimeout(() => {
        window.location.href = "https://youtu.be/VcFoPMK8x4s?t=64"
      }, 20000)
    }
  }
}

function showError(clone, msg) {
  const error = document.createElement('div')
  error.className = 'error-msg'
  error.textContent = msg
  const rect = clone.getBoundingClientRect()
  error.style.left = rect.left + 'px'
  error.style.top  = (rect.top - 26) + 'px'
  document.body.appendChild(error)
  requestAnimationFrame(()=> error.style.opacity = 1)
  setTimeout(()=> { error.style.opacity = 0; setTimeout(()=> error.remove(), 300) }, 800)
}

window.addEventListener('resize', () => { if (img.src) setup() })
</script>
</body>
</html>

